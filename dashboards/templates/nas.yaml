# Smart Appliance Monitor - NAS Dashboard Template
# Version: 1.0.0
# Optimized for NAS with session-based activity tracking
# Detects intensive activity (backups, transfers) as sessions

title: {APPLIANCE_NAME}
path: {APPLIANCE_ID}
icon: mdi:nas
type: sections
sections:
  # ============================================
  # SECTION 1: STATUS OVERVIEW
  # ============================================
  - type: grid
    cards:
      # Custom Cycle Card (adapted for NAS sessions)
      - type: custom:smart-appliance-cycle-card
        entity: sensor.{APPLIANCE_ID}_state
        name: "{APPLIANCE_NAME}"
        icon: "mdi:nas"
        show_power_graph: true
        show_action_buttons: true
        show_current_power: true
        graph_hours: 1
        theme: auto

  # ============================================
  # SECTION 2: STATISTICS
  # ============================================
  - title: Statistiques
    type: grid
    cards:
      # Custom Stats Card
      - type: custom:smart-appliance-stats-card
        entity: sensor.{APPLIANCE_ID}_state
        name: "Statistiques d'Activité"
        default_tab: today
        show_trends: true
        show_efficiency: true
        theme: auto

  # ============================================
  # SECTION 3: CURRENT ACTIVITY
  # ============================================
  - title: Activité en Cours
    type: grid
    cards:
      - type: gauge
        entity: sensor.{APPLIANCE_ID}_session_duration
        name: Durée Activité
        needle: true
        severity:
          green: 0
          yellow: 180
          red: 300
        min: 0
        max: 360  # 6h max
        unit: min

      - type: statistic
        entity: sensor.{APPLIANCE_ID}_session_energy
        name: Énergie (session)
        icon: mdi:lightning-bolt
        stat_type: mean

      - type: statistic
        entity: sensor.{APPLIANCE_ID}_session_cost
        name: Coût (session)
        icon: mdi:currency-eur
        stat_type: mean

  # ============================================
  # SECTION 4: POWER MONITORING
  # ============================================
  - title: Surveillance Puissance
    type: grid
    cards:
      - type: custom:mini-graph-card
        entities:
          - entity: sensor.{APPLIANCE_ID}_power
            name: Puissance
            color: '#e74c3c'
        name: Consommation (24h) - Détection Backup/Transfer
        hours_to_show: 24
        points_per_hour: 4
        line_width: 2
        animate: true
        show:
          labels: true
          points: false
          legend: true
          fill: fade
        icon: mdi:server
        lower_bound: 0
        upper_bound: 100

      # Activity indicator
      - type: custom:mushroom-chips-card
        chips:
          - type: template
            content: |
              {% set power = states('sensor.{APPLIANCE_ID}_power') | float(0) %}
              {% if power > 50 %}
                Activité intensive
              {% elif power > 20 %}
                Activité modérée
              {% else %}
                Inactif
              {% endif %}
            icon: mdi:signal
            icon_color: |
              {% set power = states('sensor.{APPLIANCE_ID}_power') | float(0) %}
              {% if power > 50 %}
                red
              {% elif power > 20 %}
                orange
              {% else %}
                green
              {% endif %}

  # ============================================
  # SECTION 5: CONTROLS & MONITORING
  # ============================================
  - title: Contrôles
    type: grid
    cards:
      - type: entities
        entities:
          - entity: switch.{APPLIANCE_ID}_monitoring
            name: Surveillance Activité
            icon: mdi:eye
          - entity: switch.{APPLIANCE_ID}_notifications
            name: Notifications
            icon: mdi:bell
          - type: divider
          - type: section
            label: Types de Notifications
          - entity: switch.{APPLIANCE_ID}_notification_cycle_started
            name: Activité Intensive Démarrée
            icon: mdi:backup-restore
          - entity: switch.{APPLIANCE_ID}_notification_cycle_finished
            name: Activité Terminée
            icon: mdi:check-circle
          - entity: switch.{APPLIANCE_ID}_notification_alert_duration
            name: Activité Longue
            icon: mdi:clock-alert
          - entity: switch.{APPLIANCE_ID}_notification_unplugged
            name: NAS Hors-ligne ⚠️
            icon: mdi:server-off
          - type: divider
          - type: section
            label: Actions
          - entity: button.{APPLIANCE_ID}_reset_stats
            name: Réinitialiser Statistiques
            icon: mdi:restart

  # ============================================
  # SECTION 6: ENERGY MANAGEMENT
  # ============================================
  - title: Gestion Énergétique
    type: grid
    cards:
      - type: entities
        title: Configuration
        entities:
          - entity: switch.{APPLIANCE_ID}_energy_limits
            name: Limites Énergie
            icon: mdi:speedometer
          - entity: switch.{APPLIANCE_ID}_auto_shutdown
            name: Arrêt Automatique
            icon: mdi:power-plug-off

      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.{APPLIANCE_ID}_daily_energy
            name: Énergie Jour
            min: 0
            max: 5
            unit: kWh
            needle: true
            severity:
              green: 0
              yellow: 3
              red: 4

          - type: gauge
            entity: sensor.{APPLIANCE_ID}_monthly_energy
            name: Énergie Mois
            min: 0
            max: 100
            unit: kWh
            needle: true
            severity:
              green: 0
              yellow: 60
              red: 80

      - type: entities
        title: Alertes
        entities:
          - entity: binary_sensor.{APPLIANCE_ID}_energy_limit_exceeded
            name: Limite Dépassée
            icon: mdi:alert-circle
          - entity: binary_sensor.{APPLIANCE_ID}_budget_exceeded
            name: Budget Dépassé
            icon: mdi:cash-remove

  # ============================================
  # SECTION 7: SCHEDULING
  # ============================================
  - title: Planification
    type: grid
    cards:
      - type: entities
        entities:
          - entity: switch.{APPLIANCE_ID}_scheduling
            name: Activer Planification
            icon: mdi:calendar-clock

      - type: custom:mushroom-template-card
        primary: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
            ✅ Usage Autorisé
          {% else %}
            ⛔ Usage Non Autorisé
          {% endif %}
        secondary: |
          {% if is_state('switch.{APPLIANCE_ID}_scheduling', 'on') %}
            Plage: {{ state_attr('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'allowed_start') | default('N/A', true) }} - {{ state_attr('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'allowed_end') | default('N/A', true) }}
          {% else %}
            Planification désactivée
          {% endif %}
        icon: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
            mdi:check-circle
          {% else %}
            mdi:cancel
          {% endif %}
        icon_color: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
            green
          {% else %}
            red
          {% endif %}
        tap_action:
          action: more-info
          entity: binary_sensor.{APPLIANCE_ID}_usage_allowed

  # ============================================
  # SECTION 8: AI ANALYSIS
  # ============================================
  - title: Analyse IA
    type: grid
    cards:
      - type: horizontal-stack
        cards:
          - type: button
            name: Pattern
            icon: mdi:chart-timeline-variant
            tap_action:
              action: call-service
              service: smart_appliance_monitor.analyze_cycles
              service_data:
                entity_id: sensor.{APPLIANCE_ID}_state
                analysis_type: pattern
                cycle_count: 10

          - type: button
            name: Recommendations
            icon: mdi:lightbulb-on
            tap_action:
              action: call-service
              service: smart_appliance_monitor.analyze_cycles
              service_data:
                entity_id: sensor.{APPLIANCE_ID}_state
                analysis_type: recommendations
                cycle_count: 10

          - type: button
            name: Complète
            icon: mdi:chart-box
            tap_action:
              action: call-service
              service: smart_appliance_monitor.analyze_cycles
              service_data:
                entity_id: sensor.{APPLIANCE_ID}_state
                analysis_type: all
                cycle_count: 10

      - type: entities
        title: État Analyse
        entities:
          - entity: switch.{APPLIANCE_ID}_ai_analysis
            name: Activer Analyse IA
          - entity: sensor.{APPLIANCE_ID}_ai_analysis
            name: Dernière Analyse
            secondary_info: last-changed

      - type: markdown
        content: >
          **Résumé:** {{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'summary') | default('Aucune analyse disponible', true) }}
          
          
          **Recommandations:**
          
          {{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'recommendations') | default('Aucune recommandation', true) }}

      - type: horizontal-stack
        cards:
          - type: custom:mushroom-template-card
            primary: Économies kWh
            secondary: "{{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'energy_savings_kwh') | default('N/A', true) }}"
            icon: mdi:lightning-bolt
            icon_color: green

          - type: custom:mushroom-template-card
            primary: Économies €
            secondary: "{{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'energy_savings_eur') | default('N/A', true) }} €"
            icon: mdi:currency-eur
            icon_color: green

  # ============================================
  # SECTION 9: ANOMALY DETECTION
  # ============================================
  - title: Détection d'Anomalies
    type: grid
    cards:
      - type: gauge
        entity: sensor.{APPLIANCE_ID}_anomaly_score
        name: Score d'Anomalie
        min: 0
        max: 100
        needle: true
        severity:
          green: 0
          yellow: 30
          red: 60

      - type: entities
        entities:
          - entity: binary_sensor.{APPLIANCE_ID}_anomaly_detected
            name: Anomalie Détectée
            icon: mdi:alert-circle

      - type: custom:mini-graph-card
        entities:
          - entity: sensor.{APPLIANCE_ID}_anomaly_score
            name: Score
            color: '#e74c3c'
        name: Historique Anomalies (7j)
        hours_to_show: 168
        points_per_hour: 1
        line_width: 2
        show:
          labels: true
          points: false
          legend: true
        icon: mdi:chart-line-variant

  # ============================================
  # SECTION 10: ALERTS
  # ============================================
  - title: Alertes
    type: grid
    cards:
      - type: conditional
        conditions:
          - entity: binary_sensor.{APPLIANCE_ID}_unplugged
            state: 'on'
        card:
          type: custom:mushroom-template-card
          primary: 🚨 NAS HORS-LIGNE
          secondary: Vérifier l'alimentation immédiatement
          icon: mdi:server-off
          icon_color: red
          tap_action:
            action: more-info
            entity: binary_sensor.{APPLIANCE_ID}_unplugged

      - type: conditional
        conditions:
          - entity: binary_sensor.{APPLIANCE_ID}_alert_duration
            state: 'on'
        card:
          type: custom:mushroom-template-card
          primary: ⏰ Activité Intensive Prolongée
          secondary: Backup ou transfert très long en cours
          icon: mdi:clock-alert
          icon_color: orange
          tap_action:
            action: more-info
            entity: binary_sensor.{APPLIANCE_ID}_alert_duration

      - type: conditional
        conditions:
          - entity: binary_sensor.{APPLIANCE_ID}_anomaly_detected
            state: 'on'
        card:
          type: custom:mushroom-template-card
          primary: 🔍 Anomalie Détectée
          secondary: |
            Score: {{ states('sensor.{APPLIANCE_ID}_anomaly_score') }}
          icon: mdi:alert-circle
          icon_color: orange
          tap_action:
            action: more-info
            entity: binary_sensor.{APPLIANCE_ID}_anomaly_detected

  # ============================================
  # SECTION 11: STATISTICS & ANALYSIS
  # ============================================
  - title: Statistiques
    type: grid
    cards:
      # Last Activity Session
      - type: entities
        title: Dernière Session Intensive
        icon: mdi:history
        entities:
          - entity: sensor.{APPLIANCE_ID}_last_session_duration
            name: Durée
            icon: mdi:timer
          - entity: sensor.{APPLIANCE_ID}_last_session_energy
            name: Énergie
            icon: mdi:lightning-bolt
          - entity: sensor.{APPLIANCE_ID}_last_session_cost
            name: Coût
            icon: mdi:currency-eur

      # Daily Activity
      - type: custom:mushroom-entity-card
        entity: sensor.{APPLIANCE_ID}_daily_sessions
        name: Sessions Intensives (jour)
        icon: mdi:counter
        icon_color: blue
        primary_info: state
        secondary_info: name

      # Energy costs
      - type: custom:mushroom-entity-card
        entity: sensor.{APPLIANCE_ID}_daily_cost
        name: Coût du Jour
        icon: mdi:currency-eur
        icon_color: green

      - type: custom:mushroom-entity-card
        entity: sensor.{APPLIANCE_ID}_monthly_cost
        name: Coût Mensuel
        icon: mdi:calendar-month
        icon_color: green

  # ============================================
  # SECTION 12: HEALTH & UPTIME
  # ============================================
  - title: État & Disponibilité
    type: grid
    cards:
      # Unplugged detector (critical for NAS)
      - type: custom:mushroom-template-card
        primary: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'off') %}
            ✅ NAS En Ligne
          {% else %}
            ⚠️ NAS Hors-ligne
          {% endif %}
        secondary: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'on') %}
            Aucune consommation détectée
          {% else %}
            Alimenté et fonctionnel
          {% endif %}
        icon: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'off') %}
            mdi:server-network
          {% else %}
            mdi:server-network-off
          {% endif %}
        icon_color: |
          {% if is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'off') %}
            green
          {% else %}
            red
          {% endif %}
        tap_action:
          action: more-info
          entity: binary_sensor.{APPLIANCE_ID}_unplugged

      # Current power consumption
      - type: custom:mushroom-entity-card
        entity: sensor.{APPLIANCE_ID}_power
        name: Consommation Actuelle
        icon: mdi:flash
        icon_color: |
          {% set power = states('sensor.{APPLIANCE_ID}_power') | float(0) %}
          {% if power > 50 %}
            red
          {% elif power > 20 %}
            orange
          {% else %}
            green
          {% endif %}

