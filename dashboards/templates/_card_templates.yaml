# Smart Appliance Monitor - Cartes G√©n√©riques R√©utilisables
# Version: 1.0.0
# 
# Ce fichier contient des templates de cartes r√©utilisables pour cr√©er des dashboards
# pour chaque appareil surveill√© par Smart Appliance Monitor.
#
# Variables √† remplacer:
#   {APPLIANCE_ID}        - ID de l'appareil (ex: lave_linge, dishwasher)
#   {APPLIANCE_NAME}      - Nom affich√© (ex: "Lave-Linge", "Dishwasher")
#   {ICON}                - Ic√¥ne MDI (ex: mdi:washing-machine)
#   {SESSION_OR_CYCLE}    - "cycle" ou "session" selon le type d'appareil
#   {MAX_DURATION}        - Dur√©e max en minutes pour la gauge (ex: 180)
#   {POWER_COLOR}         - Couleur du graphique de puissance (ex: '#3498db')

# ============================================
# CARTE 1: STATUS PRINCIPAL
# ============================================
# Carte mushroom template affichant le statut actuel avec badges d'alerte
card_status_principal:
  type: custom:mushroom-template-card
  primary: "{APPLIANCE_NAME}"
  secondary: |
    {% set state = states('sensor.{APPLIANCE_ID}_state') %}
    {% set duration = states('sensor.{APPLIANCE_ID}_{SESSION_OR_CYCLE}_duration') %}
    {% if state == 'running' %}
      üîµ En cours - {{ duration }} min
    {% elif state == 'finished' %}
      ‚úÖ Termin√©
    {% elif state == 'analyzing' %}
      ü§ñ Analyse IA...
    {% else %}
      ‚ö™ Inactif
    {% endif %}
  icon: "{ICON}"
  icon_color: |
    {% set state = states('sensor.{APPLIANCE_ID}_state') %}
    {% if state == 'running' %}
      blue
    {% elif state == 'finished' %}
      green
    {% elif state == 'analyzing' %}
      purple
    {% else %}
      grey
    {% endif %}
  badge_icon: |
    {% if is_state('binary_sensor.{APPLIANCE_ID}_anomaly_detected', 'on') %}
      mdi:alert-circle
    {% elif is_state('binary_sensor.{APPLIANCE_ID}_alert_duration', 'on') %}
      mdi:clock-alert
    {% elif is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'on') %}
      mdi:power-plug-off
    {% endif %}
  badge_color: |
    {% if is_state('binary_sensor.{APPLIANCE_ID}_anomaly_detected', 'on') %}
      orange
    {% elif is_state('binary_sensor.{APPLIANCE_ID}_alert_duration', 'on') or is_state('binary_sensor.{APPLIANCE_ID}_unplugged', 'on') %}
      red
    {% endif %}
  tap_action:
    action: more-info
    entity: sensor.{APPLIANCE_ID}_state
  fill_container: true

# ============================================
# CARTE 2: M√âTRIQUES CYCLE/SESSION
# ============================================
# Gauge dur√©e + statistiques √©nergie et co√ªt
card_metrics_cycle:
  type: horizontal-stack
  cards:
    - type: gauge
      entity: sensor.{APPLIANCE_ID}_{SESSION_OR_CYCLE}_duration
      name: Dur√©e
      needle: true
      severity:
        green: 0
        yellow: 60
        red: 120
      min: 0
      max: {MAX_DURATION}
      unit: min

    - type: statistic
      entity: sensor.{APPLIANCE_ID}_{SESSION_OR_CYCLE}_energy
      name: √ânergie
      icon: mdi:lightning-bolt
      stat_type: mean

    - type: statistic
      entity: sensor.{APPLIANCE_ID}_{SESSION_OR_CYCLE}_cost
      name: Co√ªt
      icon: mdi:currency-eur
      stat_type: mean

# ============================================
# CARTE 3: GRAPHIQUE PUISSANCE 24H
# ============================================
# Mini-graph-card pour la consommation des derni√®res 24h
card_power_graph:
  type: custom:mini-graph-card
  entities:
    - entity: sensor.{APPLIANCE_ID}_power
      name: Puissance
      color: "{POWER_COLOR}"
  name: Consommation (24h)
  hours_to_show: 24
  points_per_hour: 4
  line_width: 2
  animate: true
  show:
    labels: true
    points: false
    legend: true
    fill: fade
  icon: mdi:chart-line

# ============================================
# CARTE 4: CONTR√îLES COMPLETS
# ============================================
# Switches monitoring, notifications et actions
card_controls:
  type: entities
  title: Contr√¥les
  entities:
    - entity: switch.{APPLIANCE_ID}_monitoring
      name: Surveillance
      icon: mdi:eye
    - entity: switch.{APPLIANCE_ID}_notifications
      name: Notifications
      icon: mdi:bell
    - type: divider
    - type: section
      label: Notifications par Type
    - entity: switch.{APPLIANCE_ID}_notification_cycle_started
      name: Notif. D√©marrage
      icon: mdi:bell-ring
    - entity: switch.{APPLIANCE_ID}_notification_cycle_finished
      name: Notif. Fin
      icon: mdi:bell-check
    - entity: switch.{APPLIANCE_ID}_notification_alert_duration
      name: Notif. Dur√©e Anormale
      icon: mdi:bell-alert
    - entity: switch.{APPLIANCE_ID}_notification_unplugged
      name: Notif. D√©branch√©
      icon: mdi:bell-off
    - type: divider
    - type: section
      label: Actions
    - entity: button.{APPLIANCE_ID}_reset_stats
      name: R√©initialiser Statistiques
      icon: mdi:restart

# ============================================
# CARTE 5: STATISTIQUES R√âSUM√â
# ============================================
# Last cycle + daily + monthly
card_stats_summary:
  type: vertical-stack
  cards:
    - type: entities
      title: Dernier {SESSION_OR_CYCLE}
      icon: mdi:history
      entities:
        - entity: sensor.{APPLIANCE_ID}_last_{SESSION_OR_CYCLE}_duration
          name: Dur√©e
          icon: mdi:timer
        - entity: sensor.{APPLIANCE_ID}_last_{SESSION_OR_CYCLE}_energy
          name: √ânergie
          icon: mdi:lightning-bolt
        - entity: sensor.{APPLIANCE_ID}_last_{SESSION_OR_CYCLE}_cost
          name: Co√ªt
          icon: mdi:currency-eur

    - type: horizontal-stack
      cards:
        - type: custom:mushroom-entity-card
          entity: sensor.{APPLIANCE_ID}_daily_{SESSION_OR_CYCLE}s
          name: Aujourd'hui
          icon: mdi:counter
          icon_color: blue

        - type: custom:mushroom-entity-card
          entity: sensor.{APPLIANCE_ID}_daily_cost
          name: Co√ªt Jour
          icon: mdi:currency-eur
          icon_color: green

        - type: custom:mushroom-entity-card
          entity: sensor.{APPLIANCE_ID}_monthly_cost
          name: Co√ªt Mois
          icon: mdi:calendar-month
          icon_color: green

# ============================================
# CARTE 6: ALERTES CONDITIONNELLES
# ============================================
# Affiche les alertes actives (duration, unplugged, anomaly)
card_alerts:
  type: vertical-stack
  cards:
    - type: conditional
      conditions:
        - entity: binary_sensor.{APPLIANCE_ID}_alert_duration
          state: "on"
      card:
        type: custom:mushroom-template-card
        primary: ‚è∞ Dur√©e Anormale
        secondary: Le {SESSION_OR_CYCLE} d√©passe la dur√©e normale
        icon: mdi:clock-alert
        icon_color: orange
        tap_action:
          action: more-info
          entity: binary_sensor.{APPLIANCE_ID}_alert_duration

    - type: conditional
      conditions:
        - entity: binary_sensor.{APPLIANCE_ID}_unplugged
          state: "on"
      card:
        type: custom:mushroom-template-card
        primary: üîå Appareil D√©branch√©
        secondary: Aucune consommation d√©tect√©e
        icon: mdi:power-plug-off
        icon_color: red
        tap_action:
          action: more-info
          entity: binary_sensor.{APPLIANCE_ID}_unplugged

    - type: conditional
      conditions:
        - entity: binary_sensor.{APPLIANCE_ID}_anomaly_detected
          state: "on"
      card:
        type: custom:mushroom-template-card
        primary: üîç Anomalie D√©tect√©e
        secondary: |
          Score: {{ states('sensor.{APPLIANCE_ID}_anomaly_score') }}
        icon: mdi:alert-circle
        icon_color: orange
        tap_action:
          action: more-info
          entity: binary_sensor.{APPLIANCE_ID}_anomaly_detected

# ============================================
# CARTE 7: AI ANALYSIS
# ============================================
# Boutons d'analyse IA + r√©sultats
card_ai_analysis:
  type: vertical-stack
  cards:
    - type: horizontal-stack
      cards:
        - type: button
          name: Pattern
          icon: mdi:chart-timeline-variant
          tap_action:
            action: call-service
            service: smart_appliance_monitor.analyze_cycles
            service_data:
              entity_id: sensor.{APPLIANCE_ID}_state
              analysis_type: pattern
              cycle_count: 10

        - type: button
          name: Recommendations
          icon: mdi:lightbulb-on
          tap_action:
            action: call-service
            service: smart_appliance_monitor.analyze_cycles
            service_data:
              entity_id: sensor.{APPLIANCE_ID}_state
              analysis_type: recommendations
              cycle_count: 10

        - type: button
          name: Compl√®te
          icon: mdi:chart-box
          tap_action:
            action: call-service
            service: smart_appliance_monitor.analyze_cycles
            service_data:
              entity_id: sensor.{APPLIANCE_ID}_state
              analysis_type: all
              cycle_count: 10

    - type: entities
      title: √âtat Analyse IA
      entities:
        - entity: switch.{APPLIANCE_ID}_ai_analysis
          name: Activer Analyse IA
        - entity: sensor.{APPLIANCE_ID}_ai_analysis
          name: Derni√®re Analyse
          secondary_info: last-changed

    - type: markdown
      content: >
        **R√©sum√©:** {{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'summary') | default('Aucune analyse disponible', true) }}
        
        
        **Recommandations:**
        
        {{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'recommendations') | default('Aucune recommandation', true) }}

    - type: horizontal-stack
      cards:
        - type: custom:mushroom-template-card
          primary: √âconomies kWh
          secondary: "{{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'energy_savings_kwh') | default('N/A', true) }}"
          icon: mdi:lightning-bolt
          icon_color: green

        - type: custom:mushroom-template-card
          primary: √âconomies ‚Ç¨
          secondary: "{{ state_attr('sensor.{APPLIANCE_ID}_ai_analysis', 'energy_savings_eur') | default('N/A', true) }} ‚Ç¨"
          icon: mdi:currency-eur
          icon_color: green

# ============================================
# CARTE 8: ENERGY MANAGEMENT
# ============================================
# Limites √©nerg√©tiques + budgets + gauges
card_energy_management:
  type: vertical-stack
  cards:
    - type: entities
      title: Gestion √ânerg√©tique
      entities:
        - entity: switch.{APPLIANCE_ID}_energy_limits
          name: Limites √ânergie
          icon: mdi:speedometer
        - entity: switch.{APPLIANCE_ID}_auto_shutdown
          name: Arr√™t Automatique
          icon: mdi:power-plug-off

    - type: horizontal-stack
      cards:
        - type: gauge
          entity: sensor.{APPLIANCE_ID}_daily_energy
          name: √ânergie Jour
          min: 0
          max: 10
          unit: kWh
          needle: true
          severity:
            green: 0
            yellow: 6
            red: 8

        - type: gauge
          entity: sensor.{APPLIANCE_ID}_monthly_energy
          name: √ânergie Mois
          min: 0
          max: 100
          unit: kWh
          needle: true
          severity:
            green: 0
            yellow: 60
            red: 80

    - type: entities
      title: Alertes Limites
      entities:
        - entity: binary_sensor.{APPLIANCE_ID}_energy_limit_exceeded
          name: Limite √ânergie D√©pass√©e
          icon: mdi:alert-circle
        - entity: binary_sensor.{APPLIANCE_ID}_budget_exceeded
          name: Budget D√©pass√©
          icon: mdi:cash-remove

# ============================================
# CARTE 9: SCHEDULING
# ============================================
# Plages horaires autoris√©es + usage allowed
card_scheduling:
  type: vertical-stack
  cards:
    - type: entities
      title: Planification
      entities:
        - entity: switch.{APPLIANCE_ID}_scheduling
          name: Activer Planification
          icon: mdi:calendar-clock

    - type: custom:mushroom-template-card
      primary: |
        {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
          ‚úÖ Usage Autoris√©
        {% else %}
          ‚õî Usage Non Autoris√©
        {% endif %}
      secondary: |
        {% if is_state('switch.{APPLIANCE_ID}_scheduling', 'on') %}
          Plage: {{ state_attr('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'allowed_start') | default('N/A', true) }} - {{ state_attr('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'allowed_end') | default('N/A', true) }}
        {% else %}
          Planification d√©sactiv√©e
        {% endif %}
      icon: |
        {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
          mdi:check-circle
        {% else %}
          mdi:cancel
        {% endif %}
      icon_color: |
        {% if is_state('binary_sensor.{APPLIANCE_ID}_usage_allowed', 'on') %}
          green
        {% else %}
          red
        {% endif %}
      tap_action:
        action: more-info
        entity: binary_sensor.{APPLIANCE_ID}_usage_allowed

# ============================================
# CARTE CUSTOM: CYCLE CARD
# ============================================
# Carte custom JavaScript pour affichage cycle avec graphique
card_custom_cycle:
  type: custom:smart-appliance-cycle-card
  entity: sensor.{APPLIANCE_ID}_state
  name: "{APPLIANCE_NAME}"
  icon: "{ICON}"
  show_power_graph: true
  show_action_buttons: true
  show_current_power: true
  graph_hours: 0.5
  theme: auto

# ============================================
# CARTE CUSTOM: STATS CARD
# ============================================
# Carte custom JavaScript pour statistiques avec onglets
card_custom_stats:
  type: custom:smart-appliance-stats-card
  entity: sensor.{APPLIANCE_ID}_state
  name: "Statistiques {APPLIANCE_NAME}"
  default_tab: today
  show_trends: true
  show_efficiency: true
  theme: auto

# ============================================
# NOTES D'UTILISATION
# ============================================
# 
# Pour utiliser ces templates dans un dashboard:
# 
# 1. Copier la carte souhait√©e
# 2. Remplacer toutes les variables {APPLIANCE_ID}, {APPLIANCE_NAME}, etc.
# 3. Adapter les param√®tres sp√©cifiques (couleurs, seuils, dur√©es max)
#
# Exemple pour un lave-linge:
#   {APPLIANCE_ID} ‚Üí lave_linge
#   {APPLIANCE_NAME} ‚Üí Lave-Linge
#   {ICON} ‚Üí mdi:washing-machine
#   {SESSION_OR_CYCLE} ‚Üí cycle
#   {MAX_DURATION} ‚Üí 180
#   {POWER_COLOR} ‚Üí '#3498db'
#
# Pour les appareils √† "sessions" (monitor, nas, vmc):
#   {SESSION_OR_CYCLE} ‚Üí session
#

